---
title: "Pr√°ctica de la **Unidad 4. Visualizaci√≥n de datos**"
subtitle: "Del Curso introductorio al lenguaje de programaci√≥n R orientado al an√°lisis cuantitativo en Ciencias Sociales"
author: "Por Sarah√≠ Aguilar"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br/>

[üè†‚Ü© De vuelta a la p√°gina principal del curso](index.html)

<br/>

## Inicio

> #### **üöÄ Objetivo de la unidad** 
Que el estudiante conozca los distintos tipos de visualizaci√≥n de datos y reconozca sus casos de uso.

<br/>

## 5.1. Instalando y cargando paquetes
```{r}
# install.packages("ggplot2")
# install.packages("svglite") # Para expotar como svg
library(data.table)
library(ggplot2)
```

<br/> 

## 5.2. Cargando conjuntos de datos

Para la pr√°ctica utilizaremos los siguientes conjuntos de datos: 

* [Datos demogr√°ficos de los condados del medio oeste del censo de Estados Unidos de Am√©rica del 2000](https://ggplot2.tidyverse.org/reference/midwest.html)
```{r}
mw <- data.table(ggplot2::midwest)
head(mw)
```

<!-- 
<br> 

* [Datos mensuales de indicadores econ√≥micos de Estados Unidos por el Fereal Reserva Bank of St. Louis](https://ggplot2.tidyverse.org/reference/economics.html)
```{r}
eco <- data.table(ggplot2::economics)
head(eco)
```

<br/> 
-->

## 5.3. Los b√°sicos

Para crear una visualizaci√≥n, debemos:

1. Llamar a la funci√≥n `ggplot()`, que crea un lienzo en blanco.
2. Especificar con `aes()` c√≥mo deseamos asignar variables a atributos est√©ticos. 
3. Agregar capas de objetos geom√©tricos con `geom_...()`. 
4. A√±adir capas adicionales de facetas, transformaciones estad√≠sticas, coordenadas, temas, entre otros, conforme lo requiera el objetivo de nuestra visualizaci√≥n de datos.

Cada capa de la visualizaci√≥n se apila con el opeerador `+`.  

Creamos lienzo en blanco
```{r}
ggplot()
```

üí° Recuerde que nuestras visualizaciones se iran desplegando en la ventana de *Plots* o, en el caso de visualizaciones interactivas, en la ventana de *Viewer*. 

<br/> 

## 5.4. Datos

La primera y m√°s importante capa en la gram√°tica de gr√°ficos son los datos. El objeto que contiene los datos con los que construiremos nuestra visualizaci√≥n se pasa como par√°metro de la funci√≥n `ggplot()`.
```{r}
ggplot(data = mw)
```
<br>

## 5.5. Est√©tica

El siguiente paso es definir la variable que deseamos usar para cada atributo est√©tico de la visualizaci√≥n. 

En la capa de la est√©tica utilizamos la funci√≥n `aes()` para asignar variables de datos a atributos gr√°ficos utilizados por el sistema de dibujo subyacente, como posici√≥n 2D, color, tipo de l√≠nea, tama√±o, figura de los puntos, entre otros.

```{r}
ggplot(data = mw) +
  aes(x = percollege, y = percbelowpoverty, color = state)
```

<br>

## 5.6. Objetos geom√©tricos

Despu√©s de definir los atributos gr√°ficos que deseamos utilizar, debemos especificar uno o varios objetos geom√©tricos para indicar c√≥mo deben dibujarse los puntos de datos. Los objetos geom√©tricos (o `geoms`) pueden ser puntos, l√≠neas, barras, pol√≠gonos, √°reas, histogramas, rectas con el mejor ajuste, entre otros. Cu√°l utilizar [depender√° del tipo y total de variables de datos que querramos representar y qu√© mensaje querramos comunicar con la visualizaci√≥n](https://sarahiaguilar.github.io/R-4-SocialSci/cheatsheets/data-visualization.pdf). 

```{r}
ggplot(data = mw) +
  aes(x = percollege, y = percbelowpoverty) + 
  geom_point()
```

<br>
Los objetos geom√©tricos tienen sus propios par√°metros para ajustar sus atributos gr√°ficos. 
```{r}
ggplot(data = mw) +
  aes(x = percollege, y = percbelowpoverty) + 
  geom_point(color = "purple", alpha = 0.50, size = 3)
```


<br>
Es posible agrupar cuantos objetos geom√©tricos querramos. 
```{r}
ggplot(data = mw) +
  aes(x = percollege, y = percbelowpoverty) + 
  geom_point() +
  geom_smooth()
```

<br>
Algunos `geoms` utilizan transformaciones estad√≠sticas que aplican c√°lculos y agregaciones de forma impl√≠cita a los datos antes de graficarlos. 
```{r}
mw[, above_5_percblack := ifelse(test = percblack >= 5, yes = "S√≠", no = "No")]
ggplot(data = mw) +
  aes(x = state, fill = above_5_percblack) + 
  geom_bar(stat = "count")
```

<br>
```{r}
ggplot(data = mw) +
  aes(x = poptotal) + 
  geom_histogram(bins = 100)
```

<br>
```{r}
ggplot(data = mw) +
  aes(x = percpovertyknown, y = state) + 
  geom_boxplot()
```

üí° Sobre las visualizaciones de caja en ggplot2: 

* Cada l√≠nea vertical representa el cuartil 25, el 50 (la mediana) y el 75 respectivamente.
* La caja representa el rango intercuart√≠lico (diferencia entre los percentiles 75 y 25).
* El l√≠mite izquiero del bigote izquierdo representa el valor m√≠nimo de los datos que est√° dentro de 1.5 veces el rango intercuart√≠lico por debajo del percentil 25.
* El l√≠mite derecho del bigote derecho representa el valor m√°ximo de los datos que est√° dentro de 1.5 veces el rango intercuart√≠lico sobre el percentil 75.
* Los puntos representan los valores at√≠picos, que se consideran cualquier valor inferior a 1.5 veces el rango intercuart√≠lico sobre el percentil 75 o cualquier valor izquierdo a 1.5 veces el rango intercuart√≠lico bajo el percentil 25.

<br>
Igualmente, es posible especificar objetos primitivos, es decir, objetos geom√©tricos independientes de los datos. 
```{r}
mu <- mean(mw[, percpovertyknown])
ggplot(data = mw) +
  aes(x = percpovertyknown, y = state) + 
  geom_boxplot() +
  geom_vline(xintercept = mu, linetype = "dotted")
```

<br>

## 5.7. Escalas

Cada vez que asignamos variables de datos a atributos gr√°ficos (con la funci√≥n `aes()`), ggplot2 usa una escala particular para determinar el rango de valores al que se deben asignar los datos. 

Por ejemplo, cuando especificamos: `ggplot(data = mw) + aes(x = percollege, y = percbelowpoverty) + geom_point()`, ggplot2 agrega autom√°ticamente una escala predeterminada para cada asignaci√≥n.

Cada escala se puede representar mediante una funci√≥n con el siguiente nombre: `scale_`, seguido del nombre del atributo est√©tica, seguido de un `_` y seguido el tipo de dato de la variable de la escala.

```{r}
ggplot(data = mw) + 
  aes(x = percollege, y = percbelowpoverty) + 
  geom_point() +
  scale_x_continuous() +
  scale_y_continuous() + 
  scale_colour_discrete()
```

<br>
Si bien las escalas predeterminadas funcionan bien, es posible agregar expl√≠citamente diferentes escalas para reemplazar las predeterminadas. 

```{r}
ggplot(data = mw) + 
  aes(x = percollege, y = percbelowpoverty) + 
  geom_point() +
  scale_x_reverse() +
  scale_y_reverse()
```

<br>
```{r}
ggplot(data = mw) + 
  aes(x = percollege, y = percbelowpoverty, color = state) + 
  geom_point() +
  scale_color_manual(values = c("#993300", "#ff3300", "#ff6600", "#ff9999", "#ffccff")) # Colores definidos con su c√≥digo hexadecimal
```

<br>
```{r}
ggplot(data = mw) + 
  aes(x = percollege, y = percbelowpoverty, color = state) + 
  geom_point() +
  scale_color_brewer(palette = "Blues") # https://rdrr.io/cran/RColorBrewer/man/ColorBrewer.html
```

<!-- 
<br>
mw[, percollege_ := percollege/100]
mw[, percbelowpoverty_ := percbelowpoverty/100]
ggplot(data = mw) + 
  aes(x = percollege_, y = percbelowpoverty_, color = state) + 
  geom_point() +
  scale_x_continuous(labels = percent) + 
  scale_y_continuous(labels = percent)
 -->
 
<br>

## 5.8. Facetas

Las facetas (o `facets`) nos permiten agrupar datos por variables y luego graficar cada grupo individualmente un panel independiente, pero en la misma visualizaci√≥n (imagen). 

<br>
```{r}
ggplot(data = mw) + 
  aes(x = percollege, y = percbelowpoverty) + 
  geom_point() +
  facet_grid(facets = "state~above_5_percblack")
```

<br>

## 5.9. Coordenadas

El sistema de coordenadas define c√≥mo se asignan los puntos de datos a ubicaciones gr√°ficos 2D en el plano. Elegir el sistema de coordenadas correcto puede mejorar considerablemente la legibilidad de las visualizaciones de datos.

Al igual que con las escalas, los sistemas de coordenadas se especifican con funciones que comienzan con `coord_` y se agregan como una capa. 

Existe una serie de diferentes sistemas de coordenadas, que incluye:

* `coord_cartesian()` es el sistema de coordenadas cartesianas predeterminado, donde especifica los valores x y y. Este sistema de coordenadas es el predeterminado, por lo que no es necesario agregarlo en cada ocasi√≥n como capa. No obstante, especificar sus par√°metros permite establecer l√≠mites en los ejes, y por tanto, acercar o alejar la visualizaci√≥n. 
* `coord_flip()` es un sistema de coordenadas cartesianas con la x y la y volteadas.
* `coord_polar()` es un sistema de coordenadas polares.

<br>
```{r}
ggplot(data = mw) +
  aes(x = state, fill = above_5_percblack) + 
  geom_bar(stat = "count") +
  coord_flip()
```

<br> 

## 5.10. Temas

Otra excelente manera de mejorar la presentaci√≥n de nuestras visualizaciones de datos es elegir un tema no predeterminado para que nuestras visualizaciones se destaquen, haci√©ndolos m√°s bonitas y vibrantes. ggplot2 incluye [varios temas entre los que podemos elegir](https://ggplot2.tidyverse.org/reference/ggtheme.html).

```{r}
ggplot(data = mw) +
  aes(x = state, fill = above_5_percblack) + 
  geom_bar(stat = "count") +
  coord_flip() + 
  theme_classic()
```

<br>
```{r}
ggplot(data = mw) +
  aes(x = state, fill = above_5_percblack) + 
  geom_bar(stat = "count") +
  coord_flip() + 
  theme_minimal()
```

<br> 

## 5.10. Temas

Otra excelente manera de mejorar la presentaci√≥n de sus visualizaciones de datos es elegir un tema no predeterminado para que los elementos gr√°ficos destaquen, haci√©ndolos m√°s vibrantes y congruentes con el tipo variables de datos que querramos representar y qu√© mensaje querramos comunicar con la visualizaci√≥n. ggplot2 incluye [varios temas entre los que podemos elegir](https://ggplot2.tidyverse.org/reference/ggtheme.html).

```{r}
ggplot(data = mw) +
  aes(x = state, fill = above_5_percblack) + 
  geom_bar(stat = "count") +
  coord_flip() + 
  theme_classic()
```

<br>

## 5.11. T√≠tulos, etiquetas y anotaciones

Los t√≠tulos, etiquetas y anotaciones textuales (en el lienzo, los ejes, los objetos geom√©tricos y la leyenda) son una parte importante para hacer que una visualizaci√≥n sea comprensible y que comunique informaci√≥n de manera eficiente. Aunque no es una parte expl√≠cita de la gram√°tica de gr√°ficos, se considerar√≠a una variante de objeto geom√©trico.

```{r}
ggplot(data = mw) +
  aes(y = state, fill = above_5_percblack) + 
  geom_bar(stat = "count") +
  theme_classic() +
  labs(x = "Total de condados",
       y = "Estado", 
       title = "Illinois es el estado del medio oeste de Estados Unidos de Am√©rica\ncon mayor n√∫mero de condados y condados en los que 5% de su poblaci√≥n\nes afrodescendiente",
       subtitle = "Total de condados el medio oeste de Estados Unidos de Am√©rica por estado",
       fill = "Condados en los que\n5% de su poblaci√≥n es\nafrodescendiente",
       caption = "Fuente de datos: Censo de Estados Unidos de Am√©rica del 2000")
```

<br>

## 5.12. Exportaci√≥n

Una vez que la visualizaci√≥n est√© completa, este se puede exportar desde la ventana de *Plots* de forma manual o con la funci√≥n `ggsave()` de forma program√°tica despu√©s de asignar la visualizaci√≥n a un objeto. 

```{r}
v <- ggplot(data = mw) +
  aes(y = state, fill = above_5_percblack) + 
  geom_bar(stat = "count") +
  theme_classic() +
  labs(x = "Total de condados",
       y = "Estado",  
       title = "Illinois es el estado del medio oeste de Estados Unidos de Am√©rica\ncon mayor n√∫mero de condados y condados en los que 5% de su poblaci√≥n\nes afrodescendiente",
       subtitle = "Total de condados el medio oeste de Estados Unidos de Am√©rica por estado",
       fill = "Condados en los que\n5% de su poblaci√≥n es\nafrodescendiente",
       caption = "Fuente de datos: Censo de Estados Unidos de Am√©rica del 2000")
ggsave("./viz/myviz.svg", v, width = 10, height = 5)
```

<br> 

A pesar de que ggplot2 es una herramienta de visualizaci√≥n de datos robusta, no se tiene un control absoluto de todos los elementos gr√°ficos. Por ello, es recomendable importar la visualizaci√≥n como svg, un formato de archivo vectorial, que despu√©s es posible cargar en programas de edici√≥n de im√°genes digitales alternas para terminar de ajustar los m√≠nimos detalles. 

üí° [Gimp](https://www.gimp.org/) e [Inkscape](https://inkscape.org/es/) son programas de edici√≥n de im√°genes digitales gratuitos en los que resulta muy c√≥modo el ajuste de visualizaciones de datos. 
