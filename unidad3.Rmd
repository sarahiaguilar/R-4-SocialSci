---
title: "Pr√°ctica de la **Unidad 3. Procesamiento de datos**"
subtitle: "Del Curso introductorio al lenguaje de programaci√≥n R orientado al an√°lisis cuantitativo en Ciencias Sociales"
author: "Por Sarah√≠ Aguilar"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>

[üè†‚Ü© De vuelta a la p√°gina principal del curso](index.html)

<br>

## Inicio

> #### **üöÄ Objetivo de la unidad** 
Que el estudiante sea capaz de importar y exportar conjuntos de datos de y en diferentes formatos, as√≠ como ejecutar transformaciones b√°sicas sobre estas utilizando dataframes y el paquete data.table.

<br>

[üóÇ ‚¨á Descargar datos a utilizar en la pr√°ctica](data/packages/unidad3_data.zip)

<br>

## 3.1. Instalando y cargando paquetes

Las siguientes instrucciones descargan los paquetes que utilizaremos en la pr√°ctica a tu equipo de c√≥mputo. Por lo tanto, solo se debe correr una √∫nica vez (por equipo de c√≥mputo).
```{r}
# install.packages("data.table")
# install.packages("curl")
# install.packages("readxl")
# install.packages("foreign")
```

<br>
Cargando un paquete
Esta instrucci√≥n carga las funciones de los paquetes que utilizaremos a tu sesi√≥n de R actual. Por lo tanto, debemos correrla cada que vayamos a utilizar las funciones del paquete en una nueva sesi√≥n de R.
```{r}
library(data.table)
library(readxl)
library(foreign)
```

<br>

## 3.3. Creando un data table

* Desde 0

Recuerde que un data frame (y por lo tanto, un data table tambi√©n) se compone de vectores. En el siguiente bloque de c√≥digo, se instancian dos vectores inicialmente para despu√©s utilizarlos al crear un nuevo data table desde 0.
üí° Recordemos que los data tables heredan todas las propiedades de un data frame. 
```{r}
x <- 1:200
y <- rnorm(200, mean=70, sd=10)
dt <- data.table(id=x, 
                 age=y) 
```
Es importante denotar que los vectores que conformaran las columnas de un data table al crearlo desde 0, deben ser del mismo tama√±o.  

<br>

* A partir de un data frame

Para convertir un dataframe a un datatable, utilizamos la misma funci√≥n que empleamos para instanciar un data table desde 0.
```{r}
x <- 1:200
y <- rnorm(200, mean=70, sd=10)
df <- data.frame(id=x, 
                 age=y) 
dt <- data.table(df)
```

<br>

* A partir de un archivo con formato tabular

Utilizamos la funci√≥n ```fread()```, que lee y convierte el contenido del archivo en un data table.  
üí° El formato *ideal* para leer y escribir datos en un entorno de desarrollo orientado al an√°lisis de conjuntos de datos (como R) es el csv ("valores separados por comas" por sus siglas en ingl√©s).
```{r}
dt <- fread("./data/pob_censo_2020_inegi.csv")
```
üí° Note que la ruta para leer el archivo comienza en el directorio de trabajo de RStudio y que termina con el nombre completo (incluyendo sufijo) del archivo.

<br>
Tambi√©n es posible utilizar hiperv√≠nculos como ruta de lectura de un archivo. 
```{r}
dt_link <- fread("https://raw.githubusercontent.com/sarahiaguilar/R-4-SocialSci/gh-pages/data/pob_censo_2020_inegi.csv")
```

<br>
La funci√≥n fread tiene par√°metros que facilita la lectura de archivos con formatos m√°s complejos. 
üí° Recuerde que para conocer m√°s acerca de una funci√≥n espec√≠fica (incluyendo sus par√°metros y valores por defecto), corra "?" + el nombre de la funci√≥n. 

Por ejemplo, si el archivo no contiene un encabezado (nombres de columnas), podemos utilizar el par√°metro `header` para indicarlo, o si el archivo est√° separado por un caracter distinto a unaa coma, podemos utilizar el par√°metro `sep` para indicarlo.
```{r}
dt_txt <- fread("./data/pob_censo_2020_inegi.txt", header=FALSE, sep=";")
```

<br>
Para archivos xlsx utilizamos la funci√≥n `read_xlsx` del paquete `readxl`. Es necesario indicar como par√°metro de esta funci√≥n el n√∫mero de hoja que deseamos leer. Tambi√©n, es importante destacar que esta funci√≥n, a diferencia de laa funci√≥n `fread()`, no convierte el contenido del archivo en un data table, por lo que es necesario hacer dicha conversi√≥n posteriormente. 
```{r}
df_xlsx <- read_xlsx("./data/pob_censo_2020_inegi.xlsx", sheet=1) # Lee hoja n√∫mero 1
df_xlsx <- data.table(df_xlsx) # Convierte a data table
```

<br>
Para archivos sav de SPSS o dta de STATA utilizamos funciones del paquete `foreign`. 
```{r}
# df_spss <- read.spss("example.sav", to.data.frame=TRUE,
#                      use.value.labels=FALSE)
# df_stata <- read.dta("example.dta")
```

<br>

## 3.3. Conociendo a un data table
<center>
![](https://i.pinimg.com/originals/db/ef/7d/dbef7ded446bf28e9f258b1edc7d3399.gif)
</center>

<br>
Las siguientes funciones nos permiten explorar r√°pidamente la composici√≥n de un data table. Este es un paso crucial para tener un entendimiento general de "c√≥mo luce" el conjunto de datos y qu√© tipo de procesamiento requeriremos hacer sobre √©l.

üí° Es buena pr√°ctica mantener nuestro ambiente libre de variables que ya no vamos a utilizar. Es posible eliminar variables desde nuestro ambiente desde la ventana de `Environment` de RStudio, pero tambi√©n es posible con la funci√≥n `rm()`.

```{r}
rm(df, df_xlsx, dt_link, dt_txt, x, y)
```

<br>
Las siguientes funciones nos permiten explorar

<br>
La funci√≥n ```head()``` devuelve las primeras 6 observaciones de un data table.
```{r}
head(dt)
```

<br>
La funci√≥n ```tail()``` devuelve las √∫ltimas 6 observaciones de un data table. 
```{r}
tail(dt)
```

<br>
Tanto ```head()``` como ```tail()```, pueden recibir el argumento adicional ```n```, que indicar√° cu√°ntas observaciones devolver√°. 
```{r}
tail(dt, n=2) # Imprime las 2 √∫ltimas observaciones
```

<br>
La funci√≥n ```colnames()``` devuelve los nombres de las variables de un data table. 
```{r}
colnames(dt)
```

<br>
La funci√≥n ```dim()``` devuelve un vector de tama√±o 2 con las dimensiones del data table. En la primer posici√≥n del vector, se devolver√° el n√∫mero de observaciones, y en la segunda posici√≥n, el n√∫mero de variables.  
```{r}
dim(dt)
```

<br>
La funci√≥n ```nrow()``` devuelve el n√∫mero de observaciones, y la funci√≥n `ncol()`, el n√∫mero de variables.  
```{r}
nrow(dt)
```
<br>
```{r}
ncol(dt)
```

<br>
La funci√≥n ```str()``` devuelve el tipo y tama√±o de cada vector que compone a un data table A esto se le conoce como la "estructura" de un data frame. 
```{r}
str(dt)
```

<br>
La funci√≥n ```summary()``` devuelve algunas de las medidas de dispers√≥n de las variables num√©ricas de un data table e incluso el n√∫mero de `NA`s por columna (en caso de que haya). 
```{r}
summary(dt)
```

<br>
**Para data tables no muy grandes**, podemos utilizar la funci√≥n `View()` que nos permite obtener una visualizaci√≥n tabular completa de c√≥mo se ve el conjunto de datos. La visualizaci√≥n desplegada tambi√©n la podemos obtener dando click sobre el nombre del data taable en la venta de `Environment` de RStudio.  


## 3.4. Renombrando columnas de un data.table

Para simplificar el c√≥digo, es muy importante asegurarnos que los nombres de columna de nuestro data table sean *adecuados* (comienzan con una letra, utilizan √∫nicamente letras, n√∫meros y guiones bajos (_) en lugar de espacios, no utilizar caracteres epeciales, y son nombres cortos, claros y concretos). 

```setnames()``` es una funci√≥n que nos permitir√° cambiar uno o varios nombres de columna de un data.table de forma *segura*.
```{r}
setnames(dt, old=c("hombres", "mujeres"), new=c("pob_hombres", "pob mujeres"))
```

<br> 
```{r}
colnames(dt)
```

üí° Para sustituir un valor y reemplazarlo por otro valor en un vector, la `gsub()` resulta muy √∫til. En contexto, podemos utilizar `gsub()` para reemplazar un caracter especial que se repita en los nombres de columna de un data table.

<br> 
```{r}
setnames(dt,
         old = colnames(dt), 
         new = gsub(" ", "_", colnames(dt))) # Reemplaza espacios por un gui√≥n bajo en los nombres de columna del data table
```

<br> 
```{r}
colnames(dt)
```

<br> 

## 3.5. Utilizando `i` en un data table

üí° Recordemos que la forma general de sintaxis de un data table es `DT[i, j, by = k]`, y textualmente, se leer√≠a de la siguiente forma:

1. Toma `DT` 
3. Toma el subconjunto de filas `i` u ordena las filas usando las columnas `i`
3. Toma el subconjunto de columnas `j` o calcula las nuevas columnas `j`
4. Agrupando por las columnas `k`

<br>

* Tomando el subconjunto de filas `i`

Una √∫nica observaci√≥n bas√°ndonos en su √≠ndice
```{r}
dt[41, ]
```

<br>
Una secuencia de observaciones bas√°ndonos en sus √≠ndices
```{r}
dt[41:52, ]
```

<br>
Un conjunto de observaciones no secuenciales bas√°ndonos en su √≠ndices
```{r}
dt[c(41, 950, 1556), ]
```

<br>
Un conjunto de observaciones bas√°ndonos en una condici√≥n
```{r}
dt[entidad_federativa %in% c("Estados Unidos Mexicanos", "Ciudad de M√©xico", "M√©xico") & edad == 40, ]
```

<br>

* Ordenando las filas usando las columnas `i`

Con una variable de forma ascendente
```{r}
head(dt[order(pob_hombres), ])
```

<br>
Con una variable de forma descendente 
```{r}
head(dt[order(-pob_hombres), ])
```

<br>
Con dos variables de forma ascendente 
```{r}
head(dt[order(entidad_federativa, pob_hombres), ])
```

<br> 

## 3.6. Utilizando `j` en un data table

* Tomando el subconjunto de columnas `j`

Una √∫nica variable bas√°ndonos en su √≠ndice
```{r}
head(dt[, 2])
```

<br>
Una secuencia de variables bas√°ndonos en sus √≠ndices
```{r}
head(dt[, 3:4])
```

<br>
Un conjunto de variables no secuenciales bas√°ndonos en su √≠ndices
```{r}
head(dt[, c(1, 3:4)])
```

<br>
Una √∫nica variable bas√°ndonos en su nombre de columna
```{r}
head(dt[, .(entidad_federativa)])
```

<br>
Tambi√©n es posible escribir la instrucci√≥n as√≠: `dt[, .(entidad_federativa)]`. Observe que al ejecutar la instrucci√≥n sin el `.()`, el resultado es un vector. 

<br>
üí° La funci√≥n ```unique()``` devuelve todos los valores √∫nicos de un vector. Esta funci√≥n resulta √∫til para explorar r√°pidamente los valores √∫nicos de una variable categ√≥rica. 
```{r}
unique(dt[, entidad_federativa])
```

<br>
Un conjunto de variables no secuenciales bas√°ndonos en su nombre de columna.
```{r}
head(dt[, .(entidad_federativa, pob_hombres, pob_mujeres)]) 
```

<br>
Esta otra forma es tambi√©n v√°lida y debe ser utilizada en caso de que los nombres de columnas tengan caracteres especiales. 
```{r}
head(dt[, c("entidad_federativa", "pob_hombres", "pob_mujeres")]) 
```

<br>

* Calculando las nuevas columnas `j`

Al calcular una nueva columna en un data table, una iteraci√≥n por cada fila ocurre de forma impl√≠cita.

<br>
Calculando nueva variable desde 0 
```{r}
dt[, indice := 1:nrow(dt)]
head(dt)
```

<br>
Calculando nueva variable con variables ya existentes 
```{r}
dt[, pob_total := pob_hombres + pob_mujeres]
head(dt)
```
üí° **En R, las operaciones con `NA` siempre resultan en `NA`.**

<br>
Calculando variable con variables ya existentes y condicionales 
```{r}
# Se sobreescribe una variable ya existente (pob_total)
dt[, pob_hombres := ifelse(test = pob_hombres < 0, # ¬øLa poblaci√≥n de hombres en la fila es menor a 0?
                         yes = 0, # Si la condici√≥n es verdadera, devuelve 0 
                         no = pob_hombres)] # Si la condici√≥n es falsa, devuelve la misma poblaci√≥n de hombres en la fila
head(dt)
```

<br>

## 3.7. Utilizando `k` en un data table

Antes de agrupar por las columnas `k`, es necesario indicar al menos una operaci√≥n con una columna `j`.

* Operando con las columnas `j`

Una √∫nica operaci√≥n
```{r}
dt[entidad_federativa != "Estados Unidos Mexicanos", sum(pob_hombres)]
```

<br>
```{r}
dt[, .N] # .N es un conteo de observaciones
```

<br>
M√∫ltiples operaciones
```{r}
dt[entidad_federativa == "Estados Unidos Mexicanos", .(sum(pob_hombres), sum(pob_mujeres))]
```

<br>
Renombrando las operaciones
```{r}
dt[entidad_federativa != "Estados Unidos Mexicanos", .(sum_pob_h = sum(pob_hombres), sum_pob_m = sum(pob_mujeres))]
```

<br>

* Agrupando por las columnas `k`

Por una √∫nica variable
```{r}
head(dt[, .(sum_pob_h = sum(pob_hombres), sum_pob_m = sum(pob_mujeres)), by = entidad_federativa])
```

<br> 
Por m√∫ltiples variables
```{r}
head(dt[, .(sum_pob_h = sum(pob_hombres), sum_pob_m = sum(pob_mujeres)), by = .(entidad_federativa, edad)])
```
En este caso, el resultado a laa instrucci√≥n anterior luce igual al data table opriginal. 

<br> 

## üèã Ejercicio #1
1. Cree un nuevo proyecto de RStudio.
2. Cree una nueva carpeta dentro del proyecto que se llame ‚Äúdatos‚Äù y ubique dentro de esta al archivo pob_censo_2020_inegi.csv.
3. Cree una nueva carpeta dentro del proyecto que se llame "scripts" y cree un nuevo script dentro de esta. 
4. En el script, cargue el conjunto de datos del archivo a R como data table.
5. En el script, utilizando el data table, programe el c√≥digo correspondiente para resolver lo siguiente:
   
   5.1. Verifique que haya el mismo n√∫mero de observaciones por cada entidad federativa. 
   
   5.2. Ubique las observaciones y variables que contienen `NA`s, y reempl√°celos los `NA`s por un valor que considere pertinente. 
   
   5.3. Responda: ¬øcu√°l es la entidad federativa cuya relaci√≥n hombres-mujeres es la m√°s alta a nivel nacional? La relaci√≥n hombres-mujeres refiere a cu√°ntos hombres hay por cada mujer en la entidad federativa)? Puede consultar las entidades federativas que conforman cada regi√≥n geogr√°fica en el [Glosario del INEGI]("https://www.inegi.org.mx/app/glosario/").
   
   5.4. Cree un nuevo data table con la poblaci√≥n de mujeres entre 18 y 65 a√±os por regi√≥n geogr√°fica y gu√°rdelo en un nuevo archivo csv dentro de la carpeta ‚Äúdatos‚Äù del proyecto.
   
   5.5. Cree un nuevo data table con la poblaci√≥n total de 18 a√±os por entidad federativa y en √©l cree una nueva variable que refiera al porcentaje que representa la poblaci√≥n de 18 a√±os de cada entidad federativa de la poblaci√≥n total de 18 a√±os a nivel nacional.

<center>
![](https://c.tenor.com/rvNN3fvmjnAAAAAd/corgi-cute.gif)
</center>
   